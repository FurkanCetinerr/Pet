<!DOCTYPE html>
<html lang="tr">
<head>
    <title>PetLifecycle - Geli≈ümi≈ü Y√∂netici Paneli</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:200,300,400,500,600,700,800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        .nav-pills .nav-link.active { background-color: #ffb400; color: #fff; }
        .nav-pills .nav-link { color: #333; font-weight: 600; }
        .table img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
        /* Tablo h√ºcrelerini dikey ortala */
        .table td, .table th { vertical-align: middle; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
        <div class="container">
            <a class="navbar-brand" href="index.html">PetLifecycle Admin</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item"><a href="index.html" class="nav-link">Siteye D√∂n</a></li>
                    <li class="nav-item"><a href="#" id="logoutBtn" class="nav-link btn btn-danger mt-2 text-white">√áƒ±kƒ±≈ü</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <section class="ftco-section bg-light">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Y√∂netim Merkezi</h2>
                <div id="adminNameBadge" class="badge badge-warning p-2 text-white" style="font-size: 1rem;">...</div>
            </div>

            <ul class="nav nav-pills mb-4 justify-content-center bg-white p-2 rounded shadow-sm" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pills-apps-tab" data-toggle="pill" href="#pills-apps" role="tab">üìú Bekleyen Ba≈üvurular</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-pets-tab" data-toggle="pill" href="#pills-pets" role="tab">üê∂ Hayvan Y√∂netimi</a>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                
                <div class="tab-pane fade show active" id="pills-apps" role="tabpanel">
                    <div class="bg-white p-4 rounded shadow-sm">
                        <h4 class="mb-3">Onay Bekleyen ƒ∞≈ülemler</h4>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Kullanƒ±cƒ±</th>
                                        <th>Hayvan</th>
                                        <th>Mesaj</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="applicationsTable">
                                    </tbody>
                            </table>
                        </div>
                        <div id="noAppsMsg" class="text-center text-muted mt-3" style="display:none;">Hi√ßbir ba≈üvuru yok.</div>
                    </div>
                </div>

                <div class="tab-pane fade" id="pills-pets" role="tabpanel">
                    <div class="bg-white p-4 rounded shadow-sm">
                        <div class="d-flex justify-content-between mb-3 align-items-center">
                            <h4 class="mb-0">Kayƒ±tlƒ± Dostlarƒ±mƒ±z</h4>
                            <button class="btn btn-success" data-toggle="modal" data-target="#addPetModal">
                                <i class="fa fa-plus"></i> Yeni Ekle
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle table-striped">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Resim</th>
                                        <th>ƒ∞sim</th>
                                        <th>T√ºr</th>
                                        <th>Ya≈ü / Kilo</th>
                                        <th>Durum (Deƒüi≈ütir)</th>
                                        <th>Saƒülƒ±k</th>
                                        <th>Sil</th>
                                    </tr>
                                </thead>
                                <tbody id="petsTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <div class="modal fade" id="addPetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title text-white">Yeni Dost Ekle</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="addPetForm">
                        <div class="form-group">
                            <label>ƒ∞sim</label>
                            <input type="text" id="newPetName" class="form-control" placeholder="√ñrn: Pamuk" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>T√ºr</label>
                                    <select id="newPetType" class="form-control">
                                        <option value="KEDI">Kedi</option>
                                        <option value="KOPEK">K√∂pek</option>
                                        <option value="EXOTIC">Egzotik</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Durum</label>
                                    <select id="newPetStatus" class="form-control">
                                        <option value="AVAILABLE" selected>Sahiplendirilebilir</option>
                                        <option value="ADOPTED">Sahiplenildi</option>
                                        <option value="PENDING">Rezerve/Beklemede</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ya≈ü</label>
                                    <input type="number" id="newPetAge" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Kilo (kg)</label>
                                    <input type="number" step="0.1" id="newPetWeight" class="form-control" placeholder="√ñrn: 4.5" required>
                                </div>
                            </div>
                        </div>
                         <div class="form-group">
                            <label>Resim URL</label>
                            <input type="text" id="newPetImg" class="form-control" value="images/gallery-1.jpg">
                            <small class="text-muted">Varsayƒ±lan: images/gallery-1.jpg</small>
                        </div>
                        <button type="submit" class="btn btn-success w-100 py-3">Kaydet ve Yayƒ±nla</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleTitle">Saƒülƒ±k Takvimi</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                                <th>A≈üƒ±/ƒ∞≈ülem Adƒ±</th>
                                <th>Tarih</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/main.js"></script>

    <script>
        $(document).ready(function() {
            // G√úVENLƒ∞K
            var storedUser = localStorage.getItem("currentUser");
            if (!storedUser) { window.location.href = "login.html"; return; }
            var user = JSON.parse(storedUser);
            if (user.rol !== 'ADMIN') { window.location.href = "index.html"; return; }
            $("#adminNameBadge").text("Y√∂netici: " + user.ad);

            loadPendingApplications();
            loadPets();

            // 1. BA≈ûVURULARI GETƒ∞R
            function loadPendingApplications() {
                $.ajax({
                    url: "http://localhost:8080/api/admin/applications/pending",
                    method: "GET",
                    success: function(apps) {
                        var tbody = $("#applicationsTable");
                        tbody.empty();
                        if(apps.length === 0) { $("#noAppsMsg").show(); return; }
                        $("#noAppsMsg").hide();

                        apps.forEach(app => {
                            var row = `
                                <tr>
                                    <td>#${app.id}</td>
                                    <td>${app.user ? app.user.ad : '-'}</td>
                                    <td><span class="badge badge-info">${app.pet.tur}</span> ${app.pet.isim}</td>
                                    <td><small>${app.requestedInfoDetails || '-'}</small></td>
                                    <td>
                                        <button onclick="approveApp(${app.id})" class="btn btn-sm btn-success" title="Onayla"><i class="fa fa-check"></i></button>
                                        <button onclick="rejectApp(${app.id})" class="btn btn-sm btn-danger" title="Reddet"><i class="fa fa-times"></i></button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    }
                });
            }

            // 2. HAYVANLARI GETƒ∞R (G√úNCELLENDƒ∞: Dropdown ve Sil Butonu)
            function loadPets() {
                $.ajax({
                    url: "http://localhost:8080/api/pets",
                    method: "GET",
                    success: function(pets) {
                        var tbody = $("#petsTable");
                        tbody.empty();
                        pets.forEach(pet => {
                            // Saƒülƒ±k Butonu
                            let scheduleBtn = `<span class="text-muted">-</span>`;
                            if (pet.durum === 'ADOPTED') {
                                let btnText = pet.tur === 'EXOTIC' ? 'Diyet Planƒ±' : 'A≈üƒ± Takvimi';
                                let btnClass = pet.tur === 'EXOTIC' ? 'btn-warning' : 'btn-info';
                                scheduleBtn = `<button onclick="showSchedule(${pet.id}, '${pet.isim}')" class="btn btn-sm ${btnClass}">${btnText}</button>`;
                            }

                            // Kilo Kontrol√º (Null ise - yaz)
                            let weightText = pet.kilo ? pet.kilo + " kg" : "-";

                            var row = `
                                <tr>
                                    <td><img src="${pet.resimUrl}" alt="pet"></td>
                                    <td class="font-weight-bold">${pet.isim}</td>
                                    <td>${pet.tur}</td>
                                    <td>${pet.yas} ya≈ü / ${weightText}</td>
                                    <td>
                                        <select class="form-control form-control-sm" onchange="changeStatus(${pet.id}, this.value)" 
                                            style="width: 130px; border-color: ${getColor(pet.durum)}; color: ${getColor(pet.durum)}; font-weight:bold;">
                                            <option value="AVAILABLE" ${pet.durum === 'AVAILABLE' ? 'selected' : ''}>M√ºsait</option>
                                            <option value="ADOPTED" ${pet.durum === 'ADOPTED' ? 'selected' : ''}>Sahiplenildi</option>
                                            <option value="PENDING" ${pet.durum === 'PENDING' ? 'selected' : ''}>Rezerve</option>
                                        </select>
                                    </td>
                                    <td>${scheduleBtn}</td>
                                    <td>
                                        <button onclick="deletePet(${pet.id})" class="btn btn-sm btn-outline-danger" title="Sil">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                    }
                });
            }

            // 3. HAYVAN EKLE (Kilo dahil)
            $("#addPetForm").on("submit", function(e){
                e.preventDefault();
                var petData = {
                    isim: $("#newPetName").val(),
                    tur: $("#newPetType").val(),
                    yas: $("#newPetAge").val(),
                    kilo: $("#newPetWeight").val(), // YENƒ∞
                    durum: $("#newPetStatus").val(), // YENƒ∞: Se√ßilen durumu al
                    resimUrl: $("#newPetImg").val()
                };

                $.ajax({
                    url: "http://localhost:8080/api/pets",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(petData),
                    success: function() {
                        $("#addPetModal").modal("hide");
                        loadPets(); // Listeyi yenile
                    }
                });
            });
        });

        // --- GLOBAL FONKSƒ∞YONLAR ---

        // Stat√º Rengi Yardƒ±mcƒ±sƒ±
        function getColor(status) {
            if(status === 'AVAILABLE') return '#28a745'; // Ye≈üil
            if(status === 'ADOPTED') return '#6c757d';   // Gri
            if(status === 'PENDING') return '#ffc107';   // Sarƒ±
            return '#000';
        }

        // STAT√ú DEƒûƒ∞≈ûTƒ∞RME (ANLIK)
        function changeStatus(id, newStatus) {
            $.ajax({
                url: `http://localhost:8080/api/pets/${id}/status`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify({ status: newStatus }),
                success: function() {
                    // Ba≈üarƒ±lƒ± olursa hi√ßbir ≈üey yapmaya gerek yok, zaten deƒüi≈üti.
                    // ƒ∞stersen bildirim g√∂sterebilirsin: console.log("Stat√º g√ºncellendi");
                    location.reload(); // Renklerin tam oturmasƒ± i√ßin sayfayƒ± yenilemek en temizi
                },
                error: function() {
                    alert("Stat√º g√ºncellenemedi!");
                }
            });
        }

        // HAYVAN Sƒ∞LME
        function deletePet(id) {
            if(!confirm("Bu kaydƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?")) return;

            $.ajax({
                url: `http://localhost:8080/api/pets/${id}`,
                method: "DELETE",
                success: function() {
                    location.reload();
                },
                error: function() {
                    alert("Silme i≈ülemi ba≈üarƒ±sƒ±z!");
                }
            });
        }

        // ... (generateUUID, approveApp, rejectApp, showSchedule fonksiyonlarƒ± √∂nceki ile aynƒ± kalacak) ...
        function generateUUID() { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }
        
        function approveApp(id) {
            if(!confirm("Onaylƒ±yor musunuz?")) return;
            $.ajax({
                url: `http://localhost:8080/api/admin/applications/${id}/approve`,
                method: "POST",
                headers: { "Idempotency-Key": generateUUID() },
                success: function() { alert("Onaylandƒ±!"); location.reload(); },
                error: function(xhr) { alert("Hata: " + xhr.responseText); }
            });
        }

        function rejectApp(id) {
            var reason = prompt("Sebep:");
            if(!reason) return;
            $.ajax({
                url: `http://localhost:8080/api/admin/applications/${id}/reject`,
                method: "POST",
                headers: { "Idempotency-Key": generateUUID() },
                contentType: "application/json",
                data: JSON.stringify({ reason: reason }),
                success: function() { alert("Reddedildi."); location.reload(); }
            });
        }

        function showSchedule(petId, petName) {
            $("#scheduleTitle").text(petName + " ƒ∞√ßin Saƒülƒ±k Takvimi");
            $.ajax({
                url: `http://localhost:8080/api/pets/${petId}/schedule`,
                method: "GET",
                success: function(schedules) {
                    var tbody = $("#scheduleTableBody");
                    tbody.empty();
                    if(schedules.length === 0) tbody.html("<tr><td colspan='3'>Veri yok.</td></tr>");
                    schedules.forEach(item => {
                        var tarih = item.scheduledDate ? new Date(item.scheduledDate).toLocaleDateString() : '-';
                        tbody.append(`<tr><td>${item.vaccineName}</td><td>${tarih}</td><td>${item.status}</td></tr>`);
                    });
                    $("#scheduleModal").modal("show");
                }
            });
        }
    </script>
</body>
</html>